<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Market Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 1rem; }
    h1 { color: #0ff; }
    .widget { border: 1px solid #444; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #222; }
    .widget-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 0.5rem; }
    .widget-value { font-size: 1.5rem; color: #0f0; }
  </style>
</head>
<body>
  <h1>Live Market Dashboard</h1>

  <div class="widget">
    <div class="widget-title">Risk Temperature</div>
    <div class="widget-value" id="risk-temp-score">Loading...</div>
    <div id="risk-temp-status"></div>
    <div id="risk-temp-updated"></div>
  </div>

  <div class="widget">
    <div class="widget-title">SPY</div>
    <div class="widget-value" id="spy-value">Loading...</div>
  </div>

  <div class="widget">
    <div class="widget-title">VIXY</div>
    <div class="widget-value" id="vixy-value">Loading...</div>
  </div>

  <div class="widget">
    <div class="widget-title">Estimated Buffett Indicator</div>
    <div class="widget-value" id="buffett-value">Loading...</div>
  </div>

  <div class="widget">
    <div class="widget-title">Yield Curve Spread</div>
    <div class="widget-value" id="yield-value">Loading...</div>
  </div>

  <div class="widget">
    <div class="widget-title">Tesla</div>
    <div class="widget-value" id="tsla-value">Loading...</div>
  </div>

  <div class="widget">
    <div class="widget-title">Lithium ETF (LIT)</div>
    <div class="widget-value" id="lithium-value">Loading...</div>
  </div>

  <script>
    async function refreshAllWidgets() {
      try {
        const {
          spy,
          vixy,
          estimatedBuffett,
          yieldCurve,
          tsla,
          lit
        } = await fetch("/.netlify/functions/fetchAllData").then(r => r.json());

        const scoreContrib = calculateRiskTemperature({
          yield: yieldCurve?.spread,
          buffett: estimatedBuffett?.ratio,
          spy: spy?.pct,
          vixy: vixy?.pct,
          tsla: tsla?.pct,
          lit: lit?.pct
        });

        updateRiskTempDisplay(scoreContrib);

        if (spy && spy.pct !== undefined) {
          document.getElementById('spy-value').textContent = `${spy.pct.toFixed(2)}%`;
        } else {
          document.getElementById('spy-value').textContent = 'Error';
        }

        if (vixy && vixy.pct !== undefined) {
          document.getElementById('vixy-value').textContent = `${vixy.pct.toFixed(2)}%`;
        } else {
          document.getElementById('vixy-value').textContent = 'Error';
        }

        if (estimatedBuffett && estimatedBuffett.ratio !== undefined) {
          document.getElementById('buffett-value').textContent = `${estimatedBuffett.ratio.toFixed(2)}%`;
        } else {
          document.getElementById('buffett-value').textContent = 'Error';
        }

        if (yieldCurve && yieldCurve.spread !== undefined) {
          document.getElementById('yield-value').textContent = `${yieldCurve.spread.toFixed(2)}%`;
        } else {
          document.getElementById('yield-value').textContent = 'Error';
        }

        if (tsla && tsla.pct !== undefined) {
          document.getElementById('tsla-value').textContent = `${tsla.pct.toFixed(2)}%`;
        } else {
          document.getElementById('tsla-value').textContent = 'Error';
        }

        if (lit && lit.pct !== undefined) {
          document.getElementById('lithium-value').textContent = `${lit.pct.toFixed(2)}%`;
        } else {
          document.getElementById('lithium-value').textContent = 'Error';
        }

      } catch (err) {
        console.error('[refreshAllWidgets] error:', err);
      }
    }

    function calculateRiskTemperature(inputs) {
      let score = 0;
      const contributors = [];

      if (inputs.yield < 0) {
        score += 25;
        contributors.push('Yield inverted');
      }

      if (typeof inputs.buffett === 'number') {
        const buffScore = Math.min(inputs.buffett, 5) * 6;
        score += buffScore;
        contributors.push(`Buffett ${inputs.buffett.toFixed(2)}%`);
      }

      if (inputs.spy <= -1) {
        score += 10;
        contributors.push(`SPY down ${inputs.spy.toFixed(2)}%`);
      }

      if (inputs.vixy >= 5) {
        score += 10;
        contributors.push(`VIXY up ${inputs.vixy.toFixed(2)}%`);
      }

      if (inputs.tsla <= -1.5) {
        score += 10;
        contributors.push(`TSLA down ${inputs.tsla.toFixed(2)}%`);
      }

      score = Math.min(100, score);
      return { score: score.toFixed(2), contributors };
    }

    function updateRiskTempDisplay({ score, contributors }) {
      const scoreEl = document.getElementById('risk-temp-score');
      const labelEl = document.getElementById('risk-temp-status');
      const updatedEl = document.getElementById('risk-temp-updated');

      const numeric = parseFloat(score);
      let label = 'Normal';
      if (numeric >= 65) label = 'High Risk';
      else if (numeric >= 40) label = 'Caution';
      else if (numeric >= 25) label = 'Elevated';

      if (scoreEl) scoreEl.textContent = `${score}%`;
      if (labelEl) labelEl.textContent = label;
      if (updatedEl) updatedEl.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }

    window.addEventListener('DOMContentLoaded', refreshAllWidgets);
  </script>
</body>
</html>
