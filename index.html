<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Market Warning Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root { --bg:#1f212a; --card-bg:#2c2f40; --radius:18px; --shadow:0 25px 60px -15px rgba(0,0,0,0.6); --text-primary:rgba(255,255,255,0.92); --text-secondary:rgba(200,205,220,0.7); --live:#00d084; --cached:#6f7ea8; --error:#ff6f6f; --border:rgba(255,255,255,0.08); --transition:.35s cubic-bezier(.4,.2,.2,1);}
    *{box-sizing:border-box;}
    body{margin:0;padding:1.5rem 1rem 3rem;background:var(--bg);font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;color:var(--text-primary);min-height:100vh;}
    .app{max-width:1400px;margin:0 auto;display:flex;flex-direction:column;gap:1rem;}
    .header{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:.5rem;padding:.75rem 1rem;}
    .title{font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:.5rem;}
    .sub{font-size:.85rem;color:var(--text-secondary);margin-top:2px;}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:1rem;
      margin-top:.5rem;
      /* lets cards span rows nicely */
      grid-auto-rows:minmax(180px, auto);
    }
    .card{position:relative;background:var(--card-bg);border-radius:var(--radius);padding:1.25rem 1rem 1.5rem;box-shadow:var(--shadow);display:flex;flex-direction:column;transition:transform var(--transition),box-shadow var(--transition);overflow:hidden;border:1px solid var(--border);}
    .card.alert{box-shadow:0 0 25px 3px var(--error);}
    .card:hover{transform:translateY(-2px);box-shadow:0 20px 50px -10px rgba(255,255,255,0.2);}
    .small-label{font-size:.55rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin-bottom:4px;}
    h2{margin:0;font-size:.95rem;font-weight:600;letter-spacing:.5px;display:flex;justify-content:space-between;align-items:baseline;cursor:grab;}
    .value{font-size:2.2rem;font-weight:700;margin-top:6px;display:flex;align-items:baseline;gap:6px;color:var(--text-primary);position:relative;}
    .threshold-bar{position:absolute;left:0;right:0;top:50%;height:8px;border-radius:4px;transform:translateY(-50%);background:linear-gradient(90deg,#28c17d 0%,#ffcd3c 60%,#ff6f6f 100%);z-index:0;}
    .threshold-inner{position:absolute;left:0;top:0;bottom:0;border-radius:4px;z-index:1;}
    .threshold-label{margin-left:8px;font-size:.6rem;font-weight:600;letter-spacing:1px;}
    .change{font-size:.85rem;margin-top:4px;display:flex;align-items:center;gap:4px;}
    .up{color:var(--live);}
    .down{color:var(--error);}
    .badge{font-size:.55rem;padding:6px 12px;border-radius:999px;font-weight:600;display:inline-block;margin-left:6px;text-transform:uppercase;letter-spacing:.5px;background:rgba(255,255,255,0.08);color:var(--text-primary);}
    .badge-live{background:var(--live);color:#fff;font-weight:700;border:1px solid rgba(255,255,255,0.1);}
    .badge-cached{background:var(--cached);color:#fff;}
    .badge-error{background:var(--error);color:#fff;}
    .timestamp{font-size:.55rem;margin-top:6px;color:var(--text-secondary);}
    .stale{font-size:.55rem;color:var(--text-secondary);margin-top:2px;}
    .spinner{width:16px;height:16px;border:3px solid rgba(255,255,255,0.1);border-top:3px solid #8b9cff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-left:4px;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .note{font-size:.55rem;color:var(--text-secondary);margin-top:6px;}
    .mini{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-top:4px;}
    .header-right{display:flex;gap:1rem;flex-wrap:wrap;font-size:.9rem;}
    .legend{display:flex;gap:.75rem;align-items:center;}
    .legend .badge{margin:0;}
    .temp-bar{width:100%;height:14px;border-radius:7px;background:linear-gradient(90deg,#28c17d 0%,#ffcd3c 60%,#ff6f6f 100%);position:relative;overflow:hidden;margin-top:4px;}
    .temp-marker{position:absolute;top:0;bottom:0;width:6px;border-radius:3px;transform:translateX(-50%);box-shadow:0 0 12px rgba(255,255,255,0.4);}
    .temp-needle{position:absolute;top:0;bottom:0;width:2px;background:#fff;box-shadow:0 0 8px rgba(255,255,255,0.8);transform:translateX(-50%);pointer-events:none;z-index:2;}
    .temp-label{margin-top:4px;font-size:.75rem;}
    .sortable-ghost{opacity:.6;transform:scale(1.02);box-shadow:0 35px 80px -10px rgba(255,255,255,0.1);}
    /* hide threshold bars on Buffett widgets as requested */
    #card-buffett .threshold-bar,
    #card-buffett .threshold-inner,
    #card-estimated-buffett .threshold-bar,
    #card-estimated-buffett .threshold-inner {
      display:none;
    }
    /* NEW: make the Risk card tall (two rows) on larger screens */
    .card.tall { grid-row: span 2; }
    @media (max-width: 900px) {
      .card.tall { grid-row: span 1; }
    }
    /* tidy breakdown list */
    #risk-breakdown-wrap { margin-top: 6px; }
    #risk-breakdown-wrap summary { cursor: pointer; color: var(--text-secondary); font-size: .8rem; }
    #risk-breakdown { list-style: none; padding-left: 0; margin: 6px 0 0; font-size: .8rem; color: var(--text-secondary); }
    #risk-breakdown li { margin: 2px 0; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Market Warning Dashboard</div>
        <div class="sub">Dark theme · Aggregated risk temperature · Live / Cached / Alerts</div>
      </div>
      <div class="header-right">
        <div>Global updated: <strong id="global-updated">--:--:--</strong></div>
        <div class="legend">
          <div class="badge badge-live">LIVE</div>
          <div class="badge badge-cached">CACHED</div>
          <div class="badge badge-error">ERROR</div>
        </div>
      </div>
    </div>

    <div class="grid" id="dashboard-grid">
      <!-- Risk Temperature (tall, left) -->
      <div class="card tall" data-widget="risk-temp" id="card-risk-temp">
        <div class="small-label">Aggregate</div>
        <h2>Risk Temperature</h2>
        <div class="value" style="flex-direction:column;gap:4px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div id="risk-temp-score" style="font-size:2rem;">--%</div>
            <div id="risk-temp-status" class="badge" style="font-size:1.25rem;padding:4px 10px;background:none;">--</div>
          </div>
          <div class="temp-bar">
            <div class="temp-needle" id="risk-temp-needle"></div>
            <div class="temp-marker" id="risk-temp-marker" style="left:0;background:rgba(255,255,255,0.9);"></div>
          </div>
        </div>
        <div class="temp-label" id="risk-temp-details">Weighted aggregate score of all indicators</div>
        <!-- collapsible breakdown -->
        <details id="risk-breakdown-wrap">
          <summary>Breakdown</summary>
          <ul id="risk-breakdown"></ul>
        </details>
        <div class="timestamp" id="risk-temp-updated">Updated: --</div>
      </div>

      <div class="card" data-widget="sp500" id="card-sp500">
        <div class="small-label">Equity</div>
        <h2>S&P 500 (SPY)</h2>
        <div class="value" id="sp500">
          -- <span id="sp500-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="sp500-change"></div>
          <div id="sp500-status" class="badge">--</div>
        </div>
        <div class="stale" id="sp500-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="sp500-updated">Updated: --</div>
      </div>

      <div class="card" data-widget="yield" id="card-yield">
        <div class="small-label">Macro</div>
        <h2>10Y − 2Y Yield Curve Spread</h2>
        <div class="value" id="yield">
          -- <span id="yield-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="yield-change"></div>
          <div id="yield-status" class="badge">--</div>
        </div>
        <div class="stale" id="yield-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="yield-updated">Updated: --</div>
      </div>

      <div class="card" data-widget="buffett" id="card-buffett">
        <div class="small-label">Valuation</div>
        <h2>Buffett Indicator</h2>
        <div class="value" id="buffett-wrapper" style="position:relative;">
          <div style="display:flex;align-items:center;gap:6px;width:100%;">
            <div id="buffett">-- <span id="buffett-spinner" class="spinner" style="display:none;"></span></div>
            <div class="threshold-label" id="buffett-label">--</div>
          </div>
        </div>
        <div class="mini">
          <div class="change" id="buffett-change"></div>
          <div id="buffett-status" class="badge">--</div>
        </div>
        <div class="stale" id="buffett-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="buffett-updated">Updated: --</div>
        <div class="note">Market cap / GDP. High readings signal overvaluation.</div>
      </div>

      <div class="card" data-widget="tsla" id="card-tsla">
        <div class="small-label">Equity</div>
        <h2>Tesla (TSLA)</h2>
        <div class="value" id="tsla">
          -- <span id="tsla-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="tsla-change"></div>
          <div id="tsla-status" class="badge">--</div>
        </div>
        <div class="stale" id="tsla-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="tsla-updated">Updated: --</div>
      </div>

      <div class="card" data-widget="lithium" id="card-lithium">
        <div class="small-label">Commodity Proxy</div>
        <h2>Lithium Spot Proxy (LIT ETF)</h2>
        <div class="value" id="lithium">
          -- <span id="lithium-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="lithium-change"></div>
          <div id="lithium-status" class="badge">--</div>
        </div>
        <div class="stale" id="lithium-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="lithium-updated">Updated: --</div>
      </div>
      
      <!-- GOLD -->
      <div class="card" data-widget="gold" id="card-gold">
        <div class="small-label">Commodity</div>
        <h2>Gold (USD/oz)</h2>
        <div class="value" id="gold">
          -- <span id="gold-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="gold-change"></div>
          <div id="gold-status" class="badge">--</div>
        </div>
        <div class="stale" id="gold-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="gold-updated">Updated: --</div>
      </div>

      <!-- DXY (Broad USD index) -->
      <div class="card" data-widget="dxy" id="card-dxy">
        <div class="small-label">Currency</div>
        <h2>USD Broad Index (FRED)</h2>
        <div class="value" id="dxy">
          -- <span id="dxy-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="dxy-change"></div>
          <div id="dxy-status" class="badge">--</div>
        </div>
        <div class="stale" id="dxy-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="dxy-updated">Updated: --</div>
      </div>

      <div class="card" data-widget="vixindex" id="card-vix-index">
        <div class="small-label">Volatility</div>
        <h2>VIX Index (^VIX)</h2>
        <div class="value" id="vix-index">
          -- <span id="vix-index-spinner" class="spinner" style="display:none;"></span>
        </div>
        <div class="mini">
          <div class="change" id="vix-index-change"></div>
          <div id="vix-index-status" class="badge">--</div>
        </div>
        <div class="stale" id="vix-index-stale" style="display:none;">Using cached value</div>
        <div class="timestamp" id="vix-index-updated">Updated: --</div>
      </div>
    </div>

    <div class="note">
      Data sources: TwelveData for ETFs, Netlify functions for VIX index, yield spread, Estimated Buffett. Aggregated “Risk Temperature” mixes structural and near-term market stress.  
      Rule: working widgets are isolated; new features only after verified.
    </div>
  </div>

<script>
  const TWELVE_KEY = '26137bba624c4dcb9b5284ad1b234071';

  function cacheSet(key, obj) {
    try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data: obj })); }
    catch {}
  }
  function cacheGet(key) {
    try { return JSON.parse(localStorage.getItem(key)); }
    catch { return null; }
  }

  function setStatus(el, type) {
    if (!el) return;
    el.classList.remove('badge-live', 'badge-cached', 'badge-error');
    el.classList.add('badge');
    if (type === 'LIVE')       { el.textContent = 'LIVE'; el.classList.add('badge-live'); }
    else if (type === 'CACHED'){ el.textContent = 'CACHED'; el.classList.add('badge-cached'); }
    else if (type === 'ERROR') { el.textContent = 'ERROR'; el.classList.add('badge-error'); }
    else                       { el.textContent = type; }
  }

  function interpolateColor(from, to, t) {
    const f = hex => parseInt(hex.replace('#',''),16);
    const [r1,g1,b1] = [(f(from)>>16)&255, (f(from)>>8)&255, f(from)&255];
    const [r2,g2,b2] = [(f(to)>>16)&255,   (f(to)>>8)&255,   f(to)&255];
    const rn = Math.round(r1 + (r2 - r1)*t);
    const gn = Math.round(g1 + (r2 - g1)*t);
    const bn = Math.round(b1 + (r2 - b1)*t);
    return `rgb(${rn},${gn},${bn})`;
  }
  function riskColor(score) {
    return score <= 50
      ? interpolateColor('#28c17d','#ffcd3c', score/50)
      : interpolateColor('#ffcd3c','#ff6f6f', (score-50)/50);
  }

  // ──────────────────────────────────────────────────────────────
  // Unified fetch + cache-fallback
  // ──────────────────────────────────────────────────────────────
  async function refreshAllWidgets() {
    let results = {};
    try {
      results = await fetch('/.netlify/functions/fetchAllData').then(r => r.json());
    } catch (e) {
      console.error('fetchAllData failed', e);
    }

function apply(key, live, renderer) {
  // Per-key TTLs for normal use (how long a cache is allowed to live)
  const TTL = {
    gold: 6 * 3600e3,       // 6h (gold is daily but we don't want very old cache)
    dxy: 24 * 3600e3,       // 24h (daily)
    'vix-index': 2 * 3600e3 // 2h (intraday-ish)
  };

  // If the live call errors, we will only trust cache if it's younger than this.
  const MAX_CACHE_ON_ERROR = 3 * 3600e3; // 3h

  let cache = cacheGet(key);
  const now = Date.now();

  // Drop cache if it's beyond TTL for this key
  if (cache && TTL[key] && (now - cache.ts) > TTL[key]) {
    localStorage.removeItem(key);
    cache = null;
  }

  // Happy path: live is good
  if (live && !live.error) {
    renderer(live);
    setStatus(document.getElementById(key + '-status'), 'LIVE');
    cacheSet(key, live);
    const u = document.getElementById(key + '-updated');
    if (u) u.textContent = 'Updated: ' + new Date().toLocaleTimeString();
    return;
  }

  // Live errored: use cache only if it's fresh enough
  if (live?.error && cache?.data && (now - cache.ts) <= MAX_CACHE_ON_ERROR) {
    renderer(cache.data);
    setStatus(document.getElementById(key + '-status'), 'CACHED');
    const u = document.getElementById(key + '-updated');
    if (u) u.textContent = 'Updated: ' + new Date(cache.ts).toLocaleTimeString() + ' (cached)';
    return;
  }

  // Nothing usable
  const valEl = document.getElementById(key);
  if (valEl) valEl.textContent = '--';
  setStatus(document.getElementById(key + '-status'), 'ERROR');
}


      if (live?.error) {
        if (cache?.data) {
          renderer(cache.data);
          setStatus(document.getElementById(key + '-status'), 'CACHED');
          document.getElementById(key + '-updated').textContent =
            'Updated: ' + new Date(cache.ts).toLocaleTimeString() + ' (cached)';
        } else {
          document.getElementById(key).textContent = '--';
          setStatus(document.getElementById(key + '-status'), 'ERROR');
        }
      } else if (live) {
        renderer(live);
        setStatus(document.getElementById(key + '-status'), 'LIVE');
        cacheSet(key, live);
        document.getElementById(key + '-updated').textContent =
          'Updated: ' + new Date().toLocaleTimeString();
      } else {
        document.getElementById(key).textContent = '--';
      }
    }

    // SPY
    apply('sp500', results.spy, ({ price, pct }) => {
      document.getElementById('sp500').textContent = price.toFixed(2);
      const el = document.getElementById('sp500-change');
      el.textContent = `${pct >= 0 ? '▲' : '▼'} ${Math.abs(pct).toFixed(2)}%`;
      el.className = 'change ' + (pct >= 0 ? 'up' : 'down');
    });

    // TSLA
    apply('tsla', results.tsla, ({ price, pct }) => {
      document.getElementById('tsla').textContent = price.toFixed(2);
      const el = document.getElementById('tsla-change');
      el.textContent = `${pct >= 0 ? '▲' : '▼'} ${Math.abs(pct).toFixed(2)}%`;
      el.className = 'change ' + (pct >= 0 ? 'up' : 'down');
    });

    // Lithium ETF
    apply('lithium', results.lit, ({ price, pct }) => {
      document.getElementById('lithium').textContent = price.toFixed(2);
      const el = document.getElementById('lithium-change');
      el.textContent = `${pct >= 0 ? '▲' : '▼'} ${Math.abs(pct).toFixed(2)}%`;
      el.className = 'change ' + (pct >= 0 ? 'up' : 'down');
    });

    // Yield Curve
    if (results.yieldCurve?.spread != null) {
      const s = results.yieldCurve.spread, inv = results.yieldCurve.inverted;
      document.getElementById('yield').textContent = `${s.toFixed(2)}%`;
      const el = document.getElementById('yield-change');
      el.textContent = `${s >= 0 ? '▲' : '▼'} ${inv ? 'Inverted' : 'Normal'}`;
      el.className = 'change ' + (s >= 0 ? 'up' : 'down');
      setStatus(document.getElementById('yield-status'), inv ? 'INVERTED' : 'NORMAL');
      document.getElementById('yield-updated').textContent =
        'Updated: ' + new Date().toLocaleTimeString();
    }

    // True Buffett
    apply('buffett', results.buffett, ({ ratio }) => {
      document.getElementById('buffett').textContent = `${ratio.toFixed(2)}%`;
      const statusEl = document.getElementById('buffett-status');
      if (ratio >= 3.0) {
        statusEl.textContent = 'ALERT';
        statusEl.classList.add('badge-error');
        statusEl.classList.remove('badge-live');
      } else {
        statusEl.textContent = 'OK';
        statusEl.classList.add('badge-live');
        statusEl.classList.remove('badge-error');
      }
    });

    // GOLD
    apply('gold', results.gold, ({ price, pct }) => {
      document.getElementById('gold').textContent = Number(price).toFixed(2);
      const el = document.getElementById('gold-change');
      if (typeof pct === 'number') {
        el.textContent = `${pct >= 0 ? '▲' : '▼'} ${Math.abs(pct).toFixed(2)}%`;
        el.className = 'change ' + (pct >= 0 ? 'up' : 'down');
      } else {
        el.textContent = '';
        el.className = 'change';
      }
    });

    // DXY
    apply('dxy', results.dxy, ({ price, pct }) => {
      document.getElementById('dxy').textContent = Number(price).toFixed(2);
      const el = document.getElementById('dxy-change');
      if (typeof pct === 'number') {
        el.textContent = `${pct >= 0 ? '▲' : '▼'} ${Math.abs(pct).toFixed(2)}%`;
        el.className = 'change ' + (pct >= 0 ? 'up' : 'down');
      } else {
        el.textContent = '';
        el.className = 'change';
      }
    });

    // Recalc the aggregate gauge
    if (typeof refreshRiskTemperature === 'function') {
      refreshRiskTemperature();
    }
  }

  // ──────────────────────────────────────────────────────────────
  // Risk Temperature (contribution breakdown + bands)
  // ──────────────────────────────────────────────────────────────
  function refreshRiskTemperature() {
    const scoreEl   = document.getElementById('risk-temp-score');
    const statusEl  = document.getElementById('risk-temp-status');
    const needleEl  = document.getElementById('risk-temp-needle');
    const detailsEl = document.getElementById('risk-temp-details');
    const updatedEl = document.getElementById('risk-temp-updated');
    const listEl    = document.getElementById('risk-breakdown');

    const clamp = (v, lo=0, hi=100) => Math.max(lo, Math.min(hi, v));

    // read a % change from cache with fallbacks: pct → changePercent → change
    const readPct = (key) => {
      const d = cacheGet(key)?.data;
      if (!d) return null;
      for (const k of ['pct','changePercent','change']) {
        const v = d[k];
        if (typeof v === 'number' && isFinite(v)) return v;
      }
      return null;
    };

    const parts = [];

    // S&P 500 (SPY) daily % change → risk score (down = more risk)
    const spyPct = readPct('sp500');
    if (spyPct !== null) {
      const s = clamp(50 - 12 * spyPct);
      parts.push({ name: 'S&P', label: `S&P ${spyPct >= 0 ? '+' : ''}${spyPct.toFixed(2)}%`, score: s, weight: 0.20 });
    }

    // VIX index (prefer level; fallback to % change if that’s all we have)
    const vixLevel = cacheGet('vix-index')?.data?.price;
    const vixChg   = readPct('vix-index');
    if (typeof vixLevel === 'number' && isFinite(vixLevel)) {
      const s = clamp(20 + (vixLevel - 12) * 3);
      parts.push({ name: 'VIX', label: `VIX ${vixLevel.toFixed(2)}`, score: s, weight: 0.25 });
    } else if (vixChg !== null) {
      const s = clamp(50 + (vixChg * 4));
      parts.push({ name: 'VIX', label: `VIX ${vixChg >= 0 ? '+' : ''}${Math.abs(vixChg).toFixed(2)}%`, score: s, weight: 0.15 });
    }

    // Yield curve spread (10y-2y)
    const yc = cacheGet('yield')?.data?.spread;
    if (typeof yc === 'number' && isFinite(yc)) {
      const s = yc < 0
        ? clamp(70 + Math.min(30, Math.abs(yc) * 25))
        : clamp(40 - Math.min(25, yc * 20));
      parts.push({ name: 'Yield', label: `YC ${yc.toFixed(2)}%`, score: s, weight: 0.20 });
    }

    // Buffett ratio
    const buff = cacheGet('buffett')?.data?.ratio;
    if (typeof buff === 'number' && isFinite(buff)) {
      const s = clamp((buff - 120) * 0.7);
      parts.push({ name: 'Buffett', label: `Buffett ${buff.toFixed(0)}%`, score: s, weight: 0.20 });
    }

    // Gold % change
    const goldPct = readPct('gold');
    if (goldPct !== null) {
      const s = clamp(50 + goldPct * 10);
      parts.push({ name: 'Gold', label: `Gold ${goldPct >= 0 ? '+' : ''}${goldPct.toFixed(2)}%`, score: s, weight: 0.075 });
    }

    // DXY % change
    const dxyPct = readPct('dxy');
    if (dxyPct !== null) {
      const s = clamp(50 + dxyPct * 10);
      parts.push({ name: 'DXY', label: `DXY ${dxyPct >= 0 ? '+' : ''}${dxyPct.toFixed(2)}%`, score: s, weight: 0.075 });
    }

    if (!parts.length) {
      if (scoreEl)   scoreEl.textContent = '--%';
      if (statusEl)  statusEl.textContent = '--';
      if (detailsEl) detailsEl.textContent = 'Waiting for data...';
      if (needleEl)  needleEl.style.left = '0%';
      if (listEl)    listEl.innerHTML = '';
      return;
    }

    // contributions
    const withPts = parts.map(p => ({ ...p, points: p.score * p.weight }));
    const wsum    = withPts.reduce((a, p) => a + p.weight, 0) || 1;
    const score   = Math.round(withPts.reduce((a, p) => a + p.points, 0) / wsum);

    // bands: Calm 0–29, Watch 30–49, Elevated 50–74, Alert 75–100
    let band = 'Calm';
    if (score >= 75) band = 'Alert';
    else if (score >= 50) band = 'Elevated';
    else if (score >= 30) band = 'Watch';

    // Write UI
    if (scoreEl)  scoreEl.textContent = `${score}%`;
    if (statusEl) { statusEl.textContent = band; statusEl.style.color = riskColor(score); }
    if (needleEl) needleEl.style.left = `${score}%`;

    // Top drivers line (compact) — contribution points (weight × score)
    const top3 = [...withPts].sort((a,b)=>b.points-a.points).slice(0,3);
    if (detailsEl) {
      const txt = 'Top: ' + top3.map(p => `${p.name} ${(p.points).toFixed(1)}`).join(' · ');
      detailsEl.textContent = txt;
      detailsEl.title = 'Top contributors by points (weight × score). Sum of all ≈ total score.';
    }

    // Full breakdown list
    if (listEl) {
      listEl.innerHTML = withPts
        .sort((a,b)=>b.points-a.points)
        .map(p => {
          const w = Math.round(p.weight * 100);
          return `<li>${p.name} — ${w}% × ${Math.round(p.score)} → ${(p.points).toFixed(1)}</li>`;
        })
        .join('');
    }

    if (updatedEl) updatedEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();
  }

  // ──────────────────────────────────────────────────────────────
  // VIX Index (^VIX) — fetch direct from function and render
  // ──────────────────────────────────────────────────────────────
  async function refreshVIXIndex() {
    const spinner = document.getElementById('vix-index-spinner');
    if (spinner) spinner.style.display = 'inline-block';

    try {
      const res = await fetch('/.netlify/functions/vixIndex?bust=' + Date.now());
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      if (json.error) throw new Error(json.error);

      const price = Number(json.price);
      const change = (json.changePercent == null || isNaN(Number(json.changePercent)))
        ? null : Number(json.changePercent);
      if (!Number.isFinite(price)) throw new Error('Bad price from vixIndex');

      const valEl = document.getElementById('vix-index');
      if (valEl) valEl.textContent = price.toFixed(2);

      const changeEl = document.getElementById('vix-index-change');
      if (changeEl) {
        if (typeof change === 'number') {
          changeEl.textContent = `${change >= 0 ? '▲' : '▼'} ${Math.abs(change).toFixed(2)}%`;
          changeEl.className = 'change ' + (change >= 0 ? 'up' : 'down');
        } else {
          changeEl.textContent = '';
          changeEl.className = 'change';
        }
      }

      const tsEl = document.getElementById('vix-index-updated');
      if (tsEl) tsEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();

      setStatus(document.getElementById('vix-index-status'), 'LIVE');

      // cache it
      cacheSet('vix-index', { price, change });
    } catch (e) {
      console.error('VIX Index error', e);
      const c = cacheGet('vix-index');
      if (c?.data) {
        const { price, change } = c.data;
        const valEl = document.getElementById('vix-index');
        if (valEl) valEl.textContent = Number(price).toFixed(2);

        const changeEl = document.getElementById('vix-index-change');
        if (changeEl && typeof change === 'number') {
          changeEl.textContent = `${change >= 0 ? '▲' : '▼'} ${Math.abs(change).toFixed(2)}%`;
          changeEl.className = 'change ' + (change >= 0 ? 'up' : 'down');
        } else {
          changeEl.textContent = '';
          changeEl.className = 'change';
        }

        const tsEl = document.getElementById('vix-index-updated');
        if (tsEl) tsEl.textContent = 'Updated: ' + new Date(c.ts).toLocaleTimeString() + ' (cached)';

        setStatus(document.getElementById('vix-index-status'), 'CACHED');
      } else {
        const valEl = document.getElementById('vix-index');
        if (valEl) valEl.textContent = 'Error';
        setStatus(document.getElementById('vix-index-status'), 'ERROR');
      }
    } finally {
      if (spinner) spinner.style.display = 'none';
      if (typeof refreshRiskTemperature === 'function') refreshRiskTemperature();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    refreshAllWidgets();
    refreshVIXIndex();
    setInterval(refreshAllWidgets, 120000);
    setInterval(refreshVIXIndex, 120000);
  });
</script>

</body>
</html>
